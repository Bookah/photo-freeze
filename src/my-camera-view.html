<!-- Load the Polymer.Element base class -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="my-camera-view">
    <!-- Defines the element's style and local DOM -->
    <template>
        <style>
            :host {
                display: block;
                padding: 16px;
            }

            #results {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #results > div {
                width: 33%;
                text-align: center;
                line-height: 24px;
            }

            @media (max-width: 814px) {

                #results {
                    flex-flow: column;
                }

                #results > div {
                    width: 100%;
                    margin-bottom: 24px;
                }

            }

            video, canvas {
                border: 2px solid rgba(255, 255, 255, 1);
                background: #263238;
                height: 198px;
                width: 100%;
            }
        </style>

        <h1>Camera</h1>
        <div id='results'>
            <div>
                <video autoplay id="liveVideo"></video>
                <button on-click="onGetUserMediaButtonClick">Get User Media</button>
            </div>
            <div>
                <canvas id='grabFrameCanvas'></canvas>
                <button on-click="onGrabFrameButtonClick" id="grabFrameButton" disabled>Grab Frame</button>
            </div>
            <div>
                <canvas id='takePhotoCanvas'></canvas>
                <button on-click="onTakePhotoButtonClick" id="takePhotoButton" disabled>Take Photo</button>
            </div>
        </div>
        <div id="photoArea"></div>
    </template>
    <script>
        let imageCapture;
        let frames = [];
        let photos= [];

        let drawCanvas = (canvas, img) => {
            canvas.width = getComputedStyle(canvas).width.split('px')[0];
            canvas.height = getComputedStyle(canvas).height.split('px')[0];
            let ratio = Math.min(canvas.width / img.width, canvas.height / img.height);
            let x = (canvas.width - img.width * ratio) / 2;
            let y = (canvas.height - img.height * ratio) / 2;
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height,
                x, y, img.width * ratio, img.height * ratio);
        };

        let createImage = (blob) => {
            let reader = new window.FileReader();
            let img = document.createElement('img');

            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                let base64data = reader.result;
                img.src = base64data;
            };

            return img;
        };

        // Your new element extends the Polymer.Element base class
        class MyCameraView extends Polymer.Element {
            static get is() { return 'my-camera-view'; }

            onGetUserMediaButtonClick() {
                navigator.mediaDevices.getUserMedia({video: true})
                    .then(mediaStream => {
                        this.$.liveVideo.srcObject = mediaStream;
                        this.$.grabFrameButton.disabled = false;
                        this.$.takePhotoButton.disabled = false;

                        const track = mediaStream.getVideoTracks()[0];
                        imageCapture = new ImageCapture(track);
                    })
                    .catch(error => console.log(error));
            }

            onGrabFrameButtonClick() {
                imageCapture.grabFrame()
                    .then(imageBitmap => {
                        const canvas = this.$.grabFrameCanvas;
                        drawCanvas(canvas, imageBitmap);
                        frames.push(imageBitmap);
                    })
                    .catch(error => console.log(error));
            }

            onTakePhotoButtonClick() {
                imageCapture.takePhoto()
                .then((blob) => {
                    photos.push(blob);
                    let img = createImage(blob);
                    Polymer.dom(this.$.photoArea).appendChild(img);
                    return createImageBitmap(blob);
                })
                .then(imageBitmap => {
                    const canvas = this.$.takePhotoCanvas;
                    drawCanvas(canvas, imageBitmap);
                })
                .catch(error => console.log(error));
            }
        }
        // Now, register your new custom element so the browser can use it
        customElements.define(MyCameraView.is, MyCameraView);
    </script>
</dom-module>
